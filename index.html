<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>シンプル選択問題プレーヤー</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* UDフォント（ユニバーサルデザインフォント）の指定
       読みやすさを重視し、本文・設問ともにゴシック体をベースにします
    */
    body {
      font-family: "BIZ UDPGothic", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Meiryo", sans-serif;
    }
    
    /* アニメーション定義 */
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* カスタムスクロールバー（入力画面用） */
    textarea::-webkit-scrollbar { width: 8px; }
    textarea::-webkit-scrollbar-track { bg-transparent; }
    textarea::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="min-h-screen bg-white text-slate-900 flex flex-col items-center justify-center">

  <div id="app" class="w-full max-w-5xl px-6 py-8 mx-auto"></div>

  <script>
    // --- アプリの状態管理 ---
    const state = {
      jsonInput: '', // 初期値は空にする
      quizData: null,
      gameState: 'input', // input, playing, result
      currentQuestionIndex: 0,
      score: 0,
      showExplanation: false,
      selectedOption: null,
      isCorrect: null,
      errorMessage: '',
      currentShuffledOptions: []
    };

    // --- ロジック関数 ---

    function handleStartQuiz() {
      state.errorMessage = '';
      try {
        if (!state.jsonInput.trim()) {
            throw new Error('問題データが入力されていません。');
        }
        const parsed = JSON.parse(state.jsonInput);
        const normalized = normalizeQuizJson(parsed);

        // バリデーション
        if (!Array.isArray(normalized) || normalized.length === 0) {
          throw new Error('有効な問題データが見つかりません。');
        }

        normalized.forEach((item, index) => {
          if (!item.question || !item.options || !item.answer) {
            throw new Error(`問題 #${index + 1} の形式が不完全です(question, options, answerが必要です)。`);
          }
        });

        state.quizData = normalized;
        state.currentQuestionIndex = 0;
        state.score = 0;
        state.gameState = 'playing';

        prepareQuestion();
        render();

      } catch (e) {
        state.errorMessage = e?.message || 'JSONの形式が正しくありません。';
        render();
      }
    }

    // データの正規化
    function normalizeQuizJson(parsed) {
      if (parsed && Array.isArray(parsed.quiz_data)) {
        return parsed.quiz_data.map((x, i) => mapStandardItem(x, i));
      }

      const arr = Array.isArray(parsed) ? parsed
        : Array.isArray(parsed?.items) ? parsed.items
        : Array.isArray(parsed?.questions) ? parsed.questions
        : Array.isArray(parsed?.data) ? parsed.data
        : null;

      if (!arr) throw new Error("JSON形式に対応できませんでした。");

      return arr.map((item, i) => mapGenericItem(item, i));
    }

    function mapStandardItem(x, i) {
        const options = Array.isArray(x.options) ? x.options.map(String) : [];
        let answer = x.answer != null ? String(x.answer) : null;
        
        if (answer == null && x.answerIndex != null) {
            const idx = Number(x.answerIndex);
            if (options[idx]) answer = options[idx];
        }

        const category = x.category != null ? String(x.category) : '';
        const q = String(x.question ?? '');
        const question = (category ? `【${category}】` : '') + q;

        return {
            question,
            options,
            answer: String(answer),
            explanation: x.explanation != null ? String(x.explanation) : '',
            passage: x.passage != null ? String(x.passage) : ''
        };
    }

    function mapGenericItem(item, i) {
        const category = item.category != null ? String(item.category) : '';
        const passage = item.passage != null ? String(item.passage) : item.text != null ? String(item.text) : '';
        const q = item.question != null ? String(item.question) : item.q != null ? String(item.q) : '';
        
        const optionsRaw = Array.isArray(item.options) ? item.options : Array.isArray(item.choices) ? item.choices : [];
        const options = optionsRaw.map(String);

        let answer = item.answer != null ? String(item.answer) : null;
        if (answer == null && item.answerIndex != null) {
            const idx = Number(item.answerIndex);
            if (options[idx]) answer = options[idx];
        } else if (answer == null && item.correctIndex != null) {
             const idx = Number(item.correctIndex);
            if (options[idx]) answer = options[idx];
        }

        const explanation = item.explanation != null ? String(item.explanation) : item.reason != null ? String(item.reason) : '';
        const question = (category ? `【${category}】` : '') + q;

        return { question, options, answer, explanation, passage };
    }

    function prepareQuestion() {
      if (state.quizData && state.quizData.length > 0) {
        const currentQ = state.quizData[state.currentQuestionIndex];
        // 選択肢のシャッフル（オプション）
        state.currentShuffledOptions = [...currentQ.options].sort(() => Math.random() - 0.5);
        state.showExplanation = false;
        state.selectedOption = null;
        state.isCorrect = null;
      }
    }

    function handleAnswerIndex(idx) {
      if (state.showExplanation) return;
      const option = state.currentShuffledOptions[idx];
      
      const currentQ = state.quizData[state.currentQuestionIndex];
      const correct = option === currentQ.answer;

      state.selectedOption = option;
      state.isCorrect = correct;
      state.showExplanation = true;

      if (correct) state.score++;
      render();
    }

    function handleNext() {
      if (state.currentQuestionIndex + 1 < state.quizData.length) {
        state.currentQuestionIndex++;
        prepareQuestion();
        render();
      } else {
        state.gameState = 'result';
        render();
      }
    }

    function handleReset() {
      state.gameState = 'input';
      state.quizData = null;
      state.errorMessage = '';
      render();
    }

    function handleInputChange(e) {
      state.jsonInput = e.target.value;
    }

    // --- レンダリング (View) ---
    const ALPHABETS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    function render() {
      const app = document.getElementById('app');
      let mainHtml = '';

      if (state.gameState === 'input') {
        // --- 入力画面 ---
        mainHtml = `
          <div class="max-w-3xl mx-auto animate-fade-in">
            <h1 class="text-3xl font-bold text-center text-slate-800 mb-8">問題データを貼り付け</h1>
            
            <div class="relative mb-6">
              <textarea
                id="json-input"
                class="w-full h-96 p-6 font-mono text-base bg-slate-50 text-slate-800 border-2 border-slate-200 rounded-2xl focus:border-indigo-500 focus:ring-0 outline-none resize-none shadow-inner transition-colors"
                placeholder='ここにJSONデータを貼り付けてください...'
                spellcheck="false"
              >${escapeHtml(state.jsonInput)}</textarea>
              <div class="absolute bottom-4 right-4 text-slate-400 text-sm pointer-events-none">
                 paste json here
              </div>
            </div>

            <!-- GPTsリンク (アイコンなし、文言変更) -->
            <div class="mb-8 text-center">
              <a 
                href="https://chatgpt.com/g/g-6970db9c23848191975c9e0daefc339b-xuan-ze-wen-ti-jsonhua" 
                target="_blank" 
                rel="noopener noreferrer"
                class="inline-block text-slate-500 hover:text-indigo-600 transition-colors font-medium text-sm underline underline-offset-4"
              >
                「GPTs」を使って選択問題をJSON化する
              </a>
            </div>

            ${state.errorMessage ? `
              <div class="mb-6 p-4 bg-red-50 text-red-700 border border-red-200 rounded-xl flex items-center gap-3">
                <i data-lucide="alert-triangle"></i>
                <span class="font-bold">${escapeHtml(state.errorMessage)}</span>
              </div>
            ` : ''}

            <button
              onclick="handleStartQuiz()"
              class="w-full bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-5 rounded-2xl shadow-lg transform transition active:scale-[0.99] flex items-center justify-center gap-3"
            >
              <i data-lucide="play-circle" width="28" height="28"></i>
              スタート
            </button>
          </div>
        `;

      } else if (state.gameState === 'playing' && state.quizData) {
        // --- プレイ画面 ---
        const currentQ = state.quizData[state.currentQuestionIndex];

        // 選択肢ボタン生成
        const optionsHtml = state.currentShuffledOptions.map((option, idx) => {
          const labelChar = ALPHABETS[idx] || (idx + 1);
          
          // 親ボタン: items-stretch で高さを揃える
          let btnClass = "group relative w-full p-4 md:p-5 rounded-2xl border-2 text-left transition-all duration-200 flex items-stretch gap-4 ";
          // ラベル: 高さ固定を廃止 (h-12 -> h-auto/min-h), 幅固定 (w-12), テキストと同じ高さになるように伸長
          let labelClass = "flex items-center justify-center w-12 min-h-[3rem] h-auto rounded-xl text-xl font-bold shrink-0 transition-colors ";
          // テキスト: 上下中央配置
          let textClass = "flex items-center text-xl md:text-2xl font-medium leading-normal w-full py-1 ";

          if (state.showExplanation) {
            if (option === currentQ.answer) {
              btnClass += "bg-green-50 border-green-500 shadow-md transform scale-[1.01]";
              labelClass += "bg-green-500 text-white";
              textClass += "text-green-900";
            } else if (option === state.selectedOption) {
              btnClass += "bg-red-50 border-red-400 opacity-60";
              labelClass += "bg-red-400 text-white";
              textClass += "text-red-900";
            } else {
              btnClass += "bg-white border-slate-100 opacity-40 grayscale";
              labelClass += "bg-slate-200 text-slate-500";
              textClass += "text-slate-400";
            }
          } else {
            btnClass += "bg-white border-slate-200 hover:border-slate-400 hover:bg-slate-50 hover:shadow-lg active:scale-[0.99] cursor-pointer";
            labelClass += "bg-slate-100 text-slate-600 group-hover:bg-slate-300 group-hover:text-slate-800";
            textClass += "text-slate-700 group-hover:text-slate-900";
          }

          const disabledAttr = state.showExplanation ? 'disabled' : '';

          return `
            <button onclick="handleAnswerIndex(${idx})" ${disabledAttr} class="${btnClass}">
              <span class="${labelClass}">${labelChar}</span>
              <span class="${textClass}">${escapeHtml(option)}</span>
            </button>
          `;
        }).join('');

        const gridClass = state.currentShuffledOptions.length > 3 ? 'md:grid-cols-2' : 'grid-cols-1';

        mainHtml = `
          <div class="max-w-6xl mx-auto w-full animate-fade-in pb-20">
            
            <!-- 1. 本文エリア (Passage) -->
            <!-- 薄い背景、一番目立つ太字、大きめ -->
            ${currentQ.passage ? `
              <div class="mb-8 bg-slate-100 p-8 md:p-12 rounded-3xl border border-slate-200">
                <div class="text-3xl md:text-4xl leading-loose text-slate-900 tracking-wide font-bold" style="font-feature-settings: 'palt';">
                  ${escapeHtml(currentQ.passage)}
                </div>
              </div>
            ` : ''}

            <!-- 2. 設問エリア (Question) -->
            <!-- 背景なし、本文より小さく、太くしない -->
            <div class="mb-8 px-4">
              <h2 class="text-xl md:text-2xl font-medium text-slate-700 leading-snug flex items-start gap-4">
                <!-- Q: 白地、黒文字、細い枠 -->
                <span class="inline-flex items-center justify-center shrink-0 w-10 h-10 bg-white border border-slate-300 text-slate-900 text-xl font-bold rounded-lg shadow-sm mt-0.5">Q</span>
                <span class="pt-1">${escapeHtml(currentQ.question)}</span>
              </h2>
            </div>

            <!-- 3. 選択肢エリア -->
            <div class="grid gap-4 md:gap-6 ${gridClass} mb-8">
              ${optionsHtml}
            </div>

            <!-- 解説・次へエリア -->
            ${state.showExplanation ? `
              <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur shadow-[0_-4px_20px_rgba(0,0,0,0.1)] border-t border-slate-200 p-6 animate-pop z-50">
                <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
                  
                  <div class="flex-1">
                    <div class="flex items-center gap-4 mb-2">
                      ${state.isCorrect
                        ? `<div class="flex items-center gap-2 text-green-600 font-bold text-3xl"><i data-lucide="circle" width="32" height="32"></i> 正解</div>`
                        : `<div class="flex items-center gap-2 text-red-500 font-bold text-3xl"><i data-lucide="x" width="32" height="32"></i> 残念</div>`
                      }
                      <div class="text-xl text-slate-600">正解: <span class="font-bold text-slate-900">${escapeHtml(currentQ.answer)}</span></div>
                    </div>
                    ${currentQ.explanation ? `<p class="text-lg text-slate-600">${escapeHtml(currentQ.explanation)}</p>` : ''}
                  </div>

                  <button
                    onclick="handleNext()"
                    class="bg-slate-900 hover:bg-slate-800 text-white text-xl font-bold py-4 px-10 rounded-full shadow-lg flex items-center gap-2 shrink-0 transition-transform active:scale-95"
                  >
                    ${state.currentQuestionIndex + 1 === state.quizData.length ? "結果へ" : "次へ"}
                    <i data-lucide="arrow-right" width="24" height="24"></i>
                  </button>
                </div>
              </div>
              <!-- フッター分の余白 -->
              <div class="h-32"></div>
            ` : ''}
          </div>
        `;

      } else if (state.gameState === 'result') {
        // --- 結果画面 ---
        mainHtml = `
          <div class="text-center animate-pop py-10">
            <h2 class="text-4xl font-bold text-slate-400 mb-8">FINISH</h2>
            
            <div class="text-[10rem] font-black text-slate-800 leading-none mb-4">
              ${state.score}
              <span class="text-4xl text-slate-400 font-medium">/ ${state.quizData.length}</span>
            </div>
            
            <p class="text-2xl text-slate-600 mb-12">正解数</p>

            <button
              onclick="handleReset()"
              class="inline-flex items-center gap-3 text-2xl font-bold text-slate-500 hover:text-slate-800 transition-colors border-b-2 border-transparent hover:border-slate-800 pb-1"
            >
              <i data-lucide="refresh-ccw"></i>
              最初に戻る
            </button>
          </div>
        `;
      }

      app.innerHTML = mainHtml;
      lucide.createIcons();
      
      const textarea = document.getElementById('json-input');
      if (textarea) {
        textarea.addEventListener('input', handleInputChange);
        textarea.focus();
      }
    }

    // --- ユーティリティ ---
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return unsafe;
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    render();
  </script>
</body>
</html>
