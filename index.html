import React, { useState, useEffect } from 'react';
import { Play, AlertCircle, CheckCircle, XCircle, RefreshCw, FileJson, ChevronRight } from 'lucide-react';

export default function App() {
  // アプリの状態管理
  const [jsonInput, setJsonInput] = useState('');
  const [quizData, setQuizData] = useState(null);
  const [gameState, setGameState] = useState('input'); // input, playing, result
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [showExplanation, setShowExplanation] = useState(false);
  const [selectedOption, setSelectedOption] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);
  const [errorMessage, setErrorMessage] = useState('');
  
  // 現在の問題のシャッフルされた選択肢を保持
  const [currentShuffledOptions, setCurrentShuffledOptions] = useState([]);

  // デフォルトのサンプルデータ
  const sampleJson = `{
  "quiz_data": [
    {
      "question": "日本の首都はどこですか？",
      "options": ["大阪", "東京"],
      "answer": "東京",
      "explanation": "日本の首都機能は東京にあります。"
    },
    {
      "question": "信号機の「止まれ」は何色ですか？",
      "options": ["青", "黄", "赤"],
      "answer": "赤",
      "explanation": "道路交通法において、赤色は「止まれ」を意味します。"
    },
    {
      "question": "世界で一番高い山は？",
      "options": ["K2", "富士山", "チョモランマ", "キリマンジャロ"],
      "answer": "チョモランマ",
      "explanation": "チョモランマ（エベレスト）の標高は約8,848メートルです。"
    }
  ]
}`;

  // 初期ロード時にサンプルをセット
  useEffect(() => {
    if (!jsonInput) {
      setJsonInput(sampleJson);
    }
  }, []);

  // 問題が変わるたびに選択肢をシャッフル
  useEffect(() => {
    if (quizData && quizData.length > 0 && currentQuestionIndex < quizData.length) {
      const currentQ = quizData[currentQuestionIndex];
      const shuffled = [...currentQ.options].sort(() => Math.random() - 0.5);
      setCurrentShuffledOptions(shuffled);
      setShowExplanation(false);
      setSelectedOption(null);
      setIsCorrect(null);
    }
  }, [currentQuestionIndex, quizData]);

  // JSON解析とバリデーション（エラーハンドリング）
  const handleStartQuiz = () => {
    setErrorMessage('');
    try {
      const parsed = JSON.parse(jsonInput);
      
      // スキーマチェック
      if (!parsed.quiz_data || !Array.isArray(parsed.quiz_data)) {
        throw new Error("JSONには 'quiz_data' 配列が含まれている必要があります。");
      }

      if (parsed.quiz_data.length === 0) {
        throw new Error("問題データが空です。");
      }

      // 各問題の必須フィールドチェック
      parsed.quiz_data.forEach((item, index) => {
        if (!item.question || !item.options || !item.answer) {
          throw new Error(`問題 #${index + 1} に必要なフィールド(question, options, answer)が不足しています。`);
        }
        if (!item.options.includes(item.answer)) {
           throw new Error(`問題 #${index + 1} の正解が選択肢に含まれていません。`);
        }
      });

      setQuizData(parsed.quiz_data);
      setCurrentQuestionIndex(0);
      setScore(0);
      setGameState('playing');

    } catch (e) {
      setErrorMessage(e.message || "不正なJSON形式です。カンマや括弧を確認してください。");
    }
  };

  // 回答チェック処理
  const handleAnswer = (option) => {
    if (showExplanation) return; // 既に回答済みの場合は無視

    const currentQ = quizData[currentQuestionIndex];
    const correct = option === currentQ.answer;
    
    setSelectedOption(option);
    setIsCorrect(correct);
    setShowExplanation(true);
    
    if (correct) {
      setScore(s => s + 1);
    }
  };

  // 次の問題へ
  const handleNext = () => {
    if (currentQuestionIndex + 1 < quizData.length) {
      setCurrentQuestionIndex(prev => prev + 1);
    } else {
      setGameState('result');
    }
  };

  // リセット
  const handleReset = () => {
    setGameState('input');
    setQuizData(null);
    setErrorMessage('');
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans p-4 md:p-8">
      <div className="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        {/* ヘッダー */}
        <header className="bg-indigo-600 p-6 text-white flex items-center gap-3">
          <FileJson size={28} />
          <h1 className="text-2xl font-bold">選択問題メーカー</h1>
        </header>

        <main className="p-6">
          {/* --- 入力画面 --- */}
          {gameState === 'input' && (
            <div className="space-y-6">
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                <p className="font-semibold mb-1">使い方:</p>
                <p>下のエリアにJSONコードを消して新しいコードを貼り付けて「クイズを開始」を押してください。</p>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">JSONデータ入力</label>
                <textarea
                  value={jsonInput}
                  onChange={(e) => setJsonInput(e.target.value)}
                  className="w-full h-64 p-4 font-mono text-sm bg-white text-slate-700 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-y shadow-sm"
                  placeholder='{"quiz_data": [...]}'
                  spellCheck="false"
                />
              </div>

              {errorMessage && (
                <div className="flex items-center gap-2 text-red-600 bg-red-50 p-3 rounded-lg animate-pulse">
                  <AlertCircle size={20} />
                  <span className="text-sm font-medium">{errorMessage}</span>
                </div>
              )}

              <button
                onClick={handleStartQuiz}
                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform active:scale-95 duration-200"
              >
                <Play size={20} />
                クイズを開始する
              </button>
            </div>
          )}

          {/* --- クイズプレイ画面 --- */}
          {gameState === 'playing' && quizData && (
            <div className="space-y-6">
              {/* 進捗バー */}
              <div className="flex justify-between items-center text-sm text-slate-500 mb-2">
                <span>Question {currentQuestionIndex + 1} / {quizData.length}</span>
                <span>Score: {score}</span>
              </div>
              <div className="w-full bg-slate-200 rounded-full h-2">
                <div 
                  className="bg-indigo-600 h-2 rounded-full transition-all duration-300" 
                  style={{ width: `${((currentQuestionIndex + 1) / quizData.length) * 100}%` }}
                ></div>
              </div>

              {/* 問題文 */}
              <h2 className="text-xl md:text-2xl font-bold text-slate-800 leading-relaxed py-4">
                {quizData[currentQuestionIndex].question}
              </h2>

              {/* 選択肢 (動的グリッド: 選択肢が多い場合は2列、少ないなら1列など調整可能) */}
              <div className={`grid gap-4 ${currentShuffledOptions.length > 3 ? 'md:grid-cols-2' : 'grid-cols-1'}`}>
                {currentShuffledOptions.map((option, idx) => {
                  let btnClass = "p-4 rounded-xl border-2 text-left transition-all duration-200 font-medium relative overflow-hidden ";
                  
                  if (showExplanation) {
                    // 正解・不正解の表示ロジック
                    if (option === quizData[currentQuestionIndex].answer) {
                      btnClass += "bg-green-100 border-green-500 text-green-800 ring-2 ring-green-200";
                    } else if (option === selectedOption) {
                      btnClass += "bg-red-100 border-red-500 text-red-800";
                    } else {
                      btnClass += "bg-slate-50 border-slate-200 opacity-50";
                    }
                  } else {
                    // 通常時
                    btnClass += "bg-white border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md cursor-pointer active:scale-[0.98]";
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => handleAnswer(option)}
                      disabled={showExplanation}
                      className={btnClass}
                    >
                      <div className="flex justify-between items-center">
                        <span>{option}</span>
                        {showExplanation && option === quizData[currentQuestionIndex].answer && <CheckCircle size={20} className="text-green-600" />}
                        {showExplanation && option === selectedOption && option !== quizData[currentQuestionIndex].answer && <XCircle size={20} className="text-red-600" />}
                      </div>
                    </button>
                  );
                })}
              </div>

              {/* 解説エリア */}
              {showExplanation && (
                <div className="mt-6 bg-slate-100 rounded-lg p-5 border-l-4 border-indigo-500 animate-fade-in-up">
                  <h3 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                    {isCorrect ? <span className="text-green-600">正解！</span> : <span className="text-red-600">残念...</span>}
                  </h3>
                  <p className="text-slate-600 mb-4">
                    <span className="font-bold">正解: </span> 
                    {quizData[currentQuestionIndex].answer}
                  </p>
                  <p className="text-slate-700 leading-relaxed">
                    {quizData[currentQuestionIndex].explanation}
                  </p>
                  
                  <div className="mt-4 flex justify-end">
                    <button
                      onClick={handleNext}
                      className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 shadow-lg transition-transform hover:-translate-y-0.5"
                    >
                      {currentQuestionIndex + 1 === quizData.length ? "結果を見る" : "次の問題へ"}
                      <ChevronRight size={18} />
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* --- 結果画面 --- */}
          {gameState === 'result' && (
            <div className="text-center py-10 space-y-6">
              <div className="inline-flex items-center justify-center w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full mb-4">
                <CheckCircle size={48} />
              </div>
              <h2 className="text-3xl font-bold text-slate-800">テスト終了！</h2>
              
              <div className="text-5xl font-black text-indigo-600 my-4">
                {score} <span className="text-2xl text-slate-400 font-normal">/ {quizData.length}</span>
              </div>
              
              <p className="text-slate-600">
                {score === quizData.length 
                  ? "全問正解！素晴らしい知識です！" 
                  : `正解率は ${Math.round((score / quizData.length) * 100)}% でした。`}
              </p>

              <div className="pt-8">
                <button
                  onClick={handleReset}
                  className="bg-lime-600 hover:bg-lime-700 text-white font-bold py-3 px-8 rounded-lg flex items-center gap-2 mx-auto transition-colors shadow-lg"
                >
                  <RefreshCw size={20} />
                  別の問題を作る
                </button>
              </div>
            </div>
          )}
        </main>
      </div>
    </div>
  );
}
