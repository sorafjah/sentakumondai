<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz Display</title>
  <style>
    :root{
      /* 大型ディスプレイ向け（必要ならここだけ調整） */
      --font-base: clamp(22px, 2.1vw, 36px);     /* 本文・選択肢 */
      --font-question: clamp(26px, 2.6vw, 44px); /* 設問 */
      --radius: 22px;
      --border: 2px;

      --bg: #ffffff;
      --card: #ffffff;
      --muted: #f5f5f5;
      --text: #111111;
      --line: #d9d9d9;

      --ok: #1b7f3a;
      --okBg: #eaf7ef;

      --ng: #b42318;
      --ngBg: #fdecec;

      --dim: 0.42;

      --labelW: 4.5rem; /* 本文ラベルの固定幅（外側の幅は増えない） */
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);

      /* UD寄り・iPad/PCで崩れにくいフォントスタック */
      font-family:
        "BIZ UDPGothic",
        "BIZ UDゴシック",
        "Noto Sans JP",
        -apple-system,
        BlinkMacSystemFont,
        "Hiragino Sans",
        "Yu Gothic",
        "Meiryo",
        system-ui,
        sans-serif;
    }

    .screen{
      width: min(1200px, 92vw);
      margin: clamp(16px, 2.2vw, 32px) auto;
      display: grid;
      gap: clamp(12px, 1.6vw, 20px);
    }

    /* 本文カード：左にラベル（外側の幅は増やさない） */
    .passageCard{
      display: grid;
      grid-template-columns: var(--labelW) 1fr;
      border-radius: var(--radius);
      background: var(--muted);
      overflow: hidden;
    }
    .sideLabel{
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      letter-spacing: .12em;
      color: #444;
      background: #ededed;
      font-size: clamp(14px, 1.2vw, 22px);
      user-select: none;
    }
    .passageText{
      padding: clamp(12px, 1.8vw, 18px) clamp(14px, 2vw, 22px);
      font-size: var(--font-base);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 設問 */
    .questionBlock{
      padding: 0 2px;
    }
    .qLabel{
      font-size: clamp(14px, 1.2vw, 22px);
      font-weight: 900;
      color: #444;
      letter-spacing: .12em;
      margin-bottom: 6px;
      user-select: none;
    }
    .qText{
      font-size: var(--font-question);
      font-weight: 900;
      line-height: 1.25;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 選択肢 */
    .optionsGrid{
      display: grid;
      gap: clamp(10px, 1.4vw, 18px);
    }
    .cols-2{ grid-template-columns: 1fr 1fr; }
    .cols-1{ grid-template-columns: 1fr; }

    .optCard{
      width: 100%;
      text-align: left;
      border: var(--border) solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      padding: clamp(12px, 1.8vw, 18px) clamp(14px, 2vw, 20px);
      cursor: pointer;

      display: grid;
      grid-template-columns: 3.2rem 1fr;
      align-items: start;
      column-gap: clamp(10px, 1.4vw, 14px);

      min-height: clamp(78px, 9vw, 112px);
      transition: opacity .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .optCard:disabled{ cursor: default; }

    .optKey{
      font-size: clamp(26px, 2.5vw, 40px);
      font-weight: 1000;
      line-height: 1;
      user-select: none;
    }
    .optBody{
      font-size: var(--font-base);
      font-weight: 700;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* 表示前：選択中（正誤は出さない） */
    .isPicked{
      border-color: #111;
      box-shadow: 0 0 0 4px rgba(0,0,0,.10);
    }

    /* 表示後 */
    .isDim{ opacity: var(--dim); }

    .isCorrect{
      border-color: var(--ok);
      background: var(--okBg);
    }
    .isCorrectPicked{
      border-color: var(--ok);
      background: var(--okBg);
      box-shadow: 0 0 0 4px rgba(27,127,58,.12);
    }
    .isWrongPicked{
      border-color: var(--ng);
      background: var(--ngBg);
      box-shadow: 0 0 0 4px rgba(180,35,24,.10);
    }

    /* 先生操作（控えめ・右下） */
    .footerRow{
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 4px;
    }
    .btn{
      font-size: clamp(16px, 1.5vw, 26px);
      font-weight: 900;
      padding: clamp(8px, 1.2vw, 12px) clamp(12px, 1.6vw, 20px);
      border-radius: 14px;
      border: 2px solid #111;
      background: #fff;
      color: #111;
      user-select: none;
    }
    .btnPrimary{
      background: #111;
      color: #fff;
    }
    .btn:disabled{
      opacity: .35;
    }

    /* 本文が空のときは本文カードを隠す */
    .isHidden{ display: none; }
  </style>
</head>
<body>
  <main class="screen" aria-label="Quiz">
    <section id="passageCard" class="passageCard" role="note" aria-label="本文">
      <div class="sideLabel">本文</div>
      <div id="passageText" class="passageText"></div>
    </section>

    <section class="questionBlock" aria-label="問題">
      <div class="qLabel">問題</div>
      <div id="qText" class="qText"></div>
    </section>

    <section id="options" class="optionsGrid cols-2" aria-label="選択肢"></section>

    <div class="footerRow" aria-label="操作">
      <button id="revealBtn" class="btn btnPrimary" disabled>正解を表示</button>
      <button id="nextBtn" class="btn" disabled>次へ</button>
    </div>
  </main>

  <script>
    /***********************
     * ここに問題JSONを貼り付け
     * - quiz_data / items / questions / data / 直配列 に対応
     * - answerIndex 対応（A=0,B=1,C=2,D=3）
     ***********************/
    const QUIZ_SOURCE = {
      "quiz_data": [
        {
          "id": 1,
          "question": "雨の日にバスが遅れることがある理由として正しいものはどれですか。",
          "passage": "この町では、雨の日に道路が混みやすい。\nそのため、雨の日はバスの到着が遅れることがある。",
          "options": ["雨の日は人が少ないから","道路が混みやすいから","バスの本数が減るから","運転手が休むから"],
          "answerIndex": 1,
          "explanation": ""
        },
        {
          "id": 2,
          "question": "午後の公園の様子として正しいものはどれですか。",
          "passage": "この公園は、朝は人が少なく、静かです。\n午後になると、子どもたちでにぎやかになります。",
          "options": ["静かで人がいない","人が多くてにぎやか","朝より寒い","使うことができない"],
          "answerIndex": 1,
          "explanation": ""
        },
        {
          "id": 3,
          "question": "この図書館で本を借りられなくなる場合はどれですか。",
          "passage": "この図書館では、本は1人3冊まで借りられます。\n返す日を守らないと、次は借りることができません。",
          "options": ["3冊借りたとき","本を読んだとき","返す日を守らなかったとき","図書館に行かなかったとき"],
          "answerIndex": 2,
          "explanation": ""
        },
        {
          "id": 4,
          "question": "けんさんが早く寝た目的は何ですか。",
          "passage": "けんさんは、テストの前の日に早く寝ました。\n次の日、元気に学校へ行くためです。",
          "options": ["テストを受けないため","元気に学校へ行くため","宿題をしないため","友だちと遊ぶため"],
          "answerIndex": 1,
          "explanation": ""
        },
        {
          "id": 5,
          "question": "この文章の内容として正しいものはどれですか。",
          "passage": "この店は、値段が安いです。\nそのため、多くの人が買い物に来ます。",
          "options": ["この店は高い","この店は人気がある","この店は遠くにある","この店は閉まっている"],
          "answerIndex": 1,
          "explanation": ""
        }
      ]
    };

    /***********************
     * 以降：表示ロジック
     ***********************/
    const LETTERS = ["A","B","C","D","E","F"];
    const normalizeString = (s) => (s ?? "").toString().trim();

    function extractQuizArray(src){
      if (Array.isArray(src)) return src;
      if (!src || typeof src !== "object") return [];
      const keys = ["quiz_data","items","questions","data"];
      for (const k of keys){
        if (Array.isArray(src[k])) return src[k];
      }
      return [];
    }

    function answerToIndex(q){
      // 優先：answerIndex
      if (Number.isInteger(q.answerIndex)) return q.answerIndex;

      // 次：answer（A/B/C/D, 1/2/3/4, ア/イ/ウ/エ, 文字列一致）
      const ans = normalizeString(q.answer);
      if (!ans) return -1;

      // 数字（1始まり）
      if (/^\d+$/.test(ans)){
        const n = parseInt(ans, 10);
        return Number.isFinite(n) ? (n - 1) : -1;
      }

      // 英字
      const m1 = ans.match(/^[A-Fa-f]$/);
      if (m1){
        return m1[0].toUpperCase().charCodeAt(0) - "A".charCodeAt(0);
      }

      // 日本語（ア/イ/ウ/エ）
      const mapKana = { "ア":0, "イ":1, "ウ":2, "エ":3, "オ":4, "カ":5 };
      if (mapKana.hasOwnProperty(ans)) return mapKana[ans];

      // 文字列一致（optionsと完全一致）
      const opts = Array.isArray(q.options) ? q.options : [];
      const idx = opts.findIndex(o => normalizeString(o) === ans);
      return idx >= 0 ? idx : -1;
    }

    function sanitizeQuestion(raw){
      const q = { ...raw };
      q.passage = normalizeString(q.passage);
      q.question = normalizeString(q.question);
      q.options = Array.isArray(q.options) ? q.options.map(normalizeString).filter(Boolean) : [];
      q.answerIndex = answerToIndex(q);
      return q;
    }

    const state = {
      list: extractQuizArray(QUIZ_SOURCE).map(sanitizeQuestion),
      i: 0,
      picked: -1,
      revealed: false
    };

    const passageCard = document.getElementById("passageCard");
    const passageText = document.getElementById("passageText");
    const qText = document.getElementById("qText");
    const optionsEl = document.getElementById("options");
    const revealBtn = document.getElementById("revealBtn");
    const nextBtn = document.getElementById("nextBtn");

    function setGridCols(n){
      // 2択は横2枚、3-4択は2×2、その他は1列
      optionsEl.classList.remove("cols-1","cols-2");
      if (n === 2 || n === 3 || n === 4) optionsEl.classList.add("cols-2");
      else optionsEl.classList.add("cols-1");
    }

    function clearOptionStyles(){
      const cards = [...optionsEl.querySelectorAll(".optCard")];
      cards.forEach(c => {
        c.disabled = false;
        c.classList.remove("isPicked","isDim","isCorrect","isCorrectPicked","isWrongPicked");
      });
    }

    function render(){
      const q = state.list[state.i];
      if (!q){
        // 何も出さない（必要なら画面を空に）
        passageCard.classList.add("isHidden");
        qText.textContent = "";
        optionsEl.innerHTML = "";
        revealBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }

      // 本文
      if (q.passage){
        passageCard.classList.remove("isHidden");
        passageText.textContent = q.passage;
      } else {
        passageCard.classList.add("isHidden");
        passageText.textContent = "";
      }

      // 設問
      qText.textContent = q.question || "";

      // 選択肢
      optionsEl.innerHTML = "";
      const opts = q.options || [];
      setGridCols(opts.length);

      opts.forEach((text, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "optCard";
        btn.dataset.index = String(idx);

        const key = document.createElement("span");
        key.className = "optKey";
        key.textContent = LETTERS[idx] ?? String(idx + 1);

        const body = document.createElement("span");
        body.className = "optBody";
        body.textContent = text;

        btn.appendChild(key);
        btn.appendChild(body);

        btn.addEventListener("click", () => onPick(idx));
        optionsEl.appendChild(btn);
      });

      // 状態リセット
      state.picked = -1;
      state.revealed = false;
      revealBtn.disabled = true;
      nextBtn.disabled = true;
    }

    function onPick(idx){
      if (state.revealed) return;

      state.picked = idx;
      const cards = [...optionsEl.querySelectorAll(".optCard")];
      cards.forEach(c => c.classList.remove("isPicked"));
      const pickedCard = cards.find(c => Number(c.dataset.index) === idx);
      if (pickedCard) pickedCard.classList.add("isPicked");

      // 1つ選んだら先生ボタン有効化
      revealBtn.disabled = false;
    }

    function reveal(){
      const q = state.list[state.i];
      if (!q || state.revealed) return;

      state.revealed = true;

      const correctIndex = q.answerIndex;
      const cards = [...optionsEl.querySelectorAll(".optCard")];

      // 全体を落ち着かせる
      cards.forEach(c => c.classList.add("isDim"));

      // 正解カードを強調
      if (Number.isInteger(correctIndex) && correctIndex >= 0){
        const correctCard = cards.find(c => Number(c.dataset.index) === correctIndex);
        if (correctCard){
          correctCard.classList.remove("isDim");
          correctCard.classList.add("isCorrect");
        }
      }

      // 選択カードの正誤
      if (state.picked >= 0){
        const pickedCard = cards.find(c => Number(c.dataset.index) === state.picked);
        if (pickedCard){
          pickedCard.classList.remove("isDim");
          if (state.picked === correctIndex) pickedCard.classList.add("isCorrectPicked");
          else pickedCard.classList.add("isWrongPicked");
        }
      }

      // 以後操作無効化
      cards.forEach(c => (c.disabled = true));
      revealBtn.disabled = true;
      nextBtn.disabled = (state.i >= state.list.length - 1);
      if (!nextBtn.disabled) nextBtn.focus();
    }

    function next(){
      if (state.i < state.list.length - 1){
        state.i += 1;
        render();
      }
    }

    revealBtn.addEventListener("click", reveal);
    nextBtn.addEventListener("click", next);

    // キーボード操作（先生向け：非表示の補助）
    // A/B/C/D: 選択、Space: 正解表示、Enter: 次へ
    window.addEventListener("keydown", (e) => {
      const k = e.key.toUpperCase();

      if (!state.revealed && ["A","B","C","D"].includes(k)){
        const idx = k.charCodeAt(0) - "A".charCodeAt(0);
        const q = state.list[state.i];
        if (q && idx >= 0 && idx < (q.options?.length ?? 0)) onPick(idx);
      }

      if (e.key === " "){
        e.preventDefault();
        if (!revealBtn.disabled) reveal();
      }

      if (e.key === "Enter"){
        if (!nextBtn.disabled) next();
      }
    });

    // 初期表示
    render();
  </script>
</body>
</html>
